<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IPåœ°å€éƒ¨é—¨æœç´¢ç²¾å‡†åŒ–æµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-section {
            margin-bottom: 30px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .test-section h3 {
            margin-top: 0;
            color: #333;
        }
        .result {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            margin-top: 10px;
            white-space: pre-wrap;
            font-family: monospace;
            max-height: 300px;
            overflow-y: auto;
        }
        .success {
            border-left: 4px solid #28a745;
            background-color: #d4edda;
        }
        .error {
            border-left: 4px solid #dc3545;
            background-color: #f8d7da;
        }
        .warning {
            border-left: 4px solid #ffc107;
            background-color: #fff3cd;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        button:hover {
            background: #0056b3;
        }
        .test-input {
            width: 200px;
            padding: 8px;
            margin-right: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .comparison-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        .comparison-table th,
        .comparison-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        .comparison-table th {
            background-color: #f8f9fa;
        }
        .highlight {
            background-color: #fff3cd;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>IPåœ°å€éƒ¨é—¨æœç´¢ç²¾å‡†åŒ–æµ‹è¯•</h1>
        <p>æµ‹è¯•ä¿®å¤åçš„éƒ¨é—¨æœç´¢åŠŸèƒ½ï¼ŒéªŒè¯æœç´¢ç»“æœçš„ç²¾å‡†æ€§</p>

        <div class="test-section">
            <h3>1. éƒ¨é—¨ç²¾ç¡®ç­›é€‰æµ‹è¯•</h3>
            <p>ä½¿ç”¨éƒ¨é—¨ç­›é€‰å™¨è¿›è¡Œç²¾ç¡®åŒ¹é…æœç´¢</p>
            <select id="dept-filter" class="test-input">
                <option value="">é€‰æ‹©éƒ¨é—¨...</option>
            </select>
            <button onclick="testDepartmentFilter()">æµ‹è¯•éƒ¨é—¨ç­›é€‰</button>
            <div id="filter-result" class="result"></div>
        </div>

        <div class="test-section">
            <h3>2. æ–‡æœ¬æœç´¢æµ‹è¯•</h3>
            <p>åœ¨æœç´¢æ¡†ä¸­è¾“å…¥éƒ¨é—¨åç§°ï¼Œæµ‹è¯•æœç´¢ç»“æœçš„ç²¾å‡†æ€§</p>
            <input type="text" id="text-search" class="test-input" placeholder="è¾“å…¥æœç´¢å…³é”®è¯">
            <button onclick="testTextSearch()">æµ‹è¯•æ–‡æœ¬æœç´¢</button>
            <div id="text-result" class="result"></div>
        </div>

        <div class="test-section">
            <h3>3. æœç´¢å¯¹æ¯”æµ‹è¯•</h3>
            <p>å¯¹æ¯”ä¸åŒæœç´¢æ–¹å¼çš„ç»“æœï¼ŒéªŒè¯ç²¾å‡†æ€§æ”¹è¿›</p>
            <button onclick="runComparisonTest()">è¿è¡Œå¯¹æ¯”æµ‹è¯•</button>
            <div id="comparison-result" class="result"></div>
            <table id="comparison-table" class="comparison-table" style="display: none;">
                <thead>
                    <tr>
                        <th>æœç´¢æ–¹å¼</th>
                        <th>æœç´¢å…³é”®è¯</th>
                        <th>ç»“æœæ•°é‡</th>
                        <th>åŒ¹é…çš„éƒ¨é—¨</th>
                        <th>ç²¾å‡†åº¦è¯„ä¼°</th>
                    </tr>
                </thead>
                <tbody id="comparison-tbody">
                </tbody>
            </table>
        </div>

        <div class="test-section">
            <h3>4. ç•Œé¢æ ‡ç­¾éªŒè¯</h3>
            <p>éªŒè¯"åˆ†é…ç»™"æ˜¯å¦å·²æ”¹ä¸º"åˆ†é…éƒ¨é—¨"</p>
            <button onclick="testUILabels()">æ£€æŸ¥ç•Œé¢æ ‡ç­¾</button>
            <div id="ui-result" class="result"></div>
        </div>

        <div class="test-section">
            <h3>5. æµ‹è¯•æ€»ç»“</h3>
            <div id="summary-result" class="result">ç‚¹å‡»ä¸Šé¢çš„æµ‹è¯•æŒ‰é’®å¼€å§‹æµ‹è¯•...</div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8000/api';
        let departments = [];
        let testResults = {
            departmentFilter: false,
            textSearch: false,
            comparison: false,
            uiLabels: false
        };

        // åˆå§‹åŒ–ï¼šåŠ è½½éƒ¨é—¨åˆ—è¡¨
        async function initializeDepartments() {
            try {
                const response = await fetch(`${API_BASE}/departments/options`);
                const data = await response.json();
                
                if (response.ok && data.departments) {
                    departments = data.departments;
                    
                    // å¡«å……éƒ¨é—¨ç­›é€‰ä¸‹æ‹‰æ¡†
                    const select = document.getElementById('dept-filter');
                    departments.forEach(dept => {
                        const option = document.createElement('option');
                        option.value = dept.name;
                        option.textContent = dept.name;
                        select.appendChild(option);
                    });
                    

                }
            } catch (error) {

            }
        }

        // æµ‹è¯•éƒ¨é—¨ç­›é€‰åŠŸèƒ½
        async function testDepartmentFilter() {
            const resultDiv = document.getElementById('filter-result');
            const selectedDept = document.getElementById('dept-filter').value;
            
            if (!selectedDept) {
                resultDiv.textContent = 'âŒ è¯·å…ˆé€‰æ‹©ä¸€ä¸ªéƒ¨é—¨';
                resultDiv.className = 'result error';
                return;
            }
            
            resultDiv.textContent = `æ­£åœ¨æµ‹è¯•éƒ¨é—¨ç­›é€‰: ${selectedDept}...`;
            
            try {
                const response = await fetch(`${API_BASE}/ips/search?assigned_to=${encodeURIComponent(selectedDept)}`);
                const data = await response.json();
                
                if (response.ok) {
                    const results = data.data || data || [];
                    const matchingDepts = [...new Set(results.map(ip => ip.assigned_to).filter(dept => dept))];
                    
                    let resultText = `âœ… éƒ¨é—¨ç­›é€‰æµ‹è¯•å®Œæˆ\n`;
                    resultText += `æœç´¢éƒ¨é—¨: ${selectedDept}\n`;
                    resultText += `è¿”å›ç»“æœ: ${results.length} æ¡IPè®°å½•\n`;
                    resultText += `åŒ¹é…çš„éƒ¨é—¨: ${matchingDepts.join(', ')}\n\n`;
                    
                    // æ£€æŸ¥ç²¾å‡†æ€§
                    const isAccurate = matchingDepts.length === 0 || 
                                     (matchingDepts.length === 1 && matchingDepts[0] === selectedDept);
                    
                    if (isAccurate) {
                        resultText += 'ğŸ¯ ç²¾å‡†åº¦: ä¼˜ç§€ - åªè¿”å›äº†å®Œå…¨åŒ¹é…çš„ç»“æœ';
                        resultDiv.className = 'result success';
                        testResults.departmentFilter = true;
                    } else {
                        resultText += 'âš ï¸ ç²¾å‡†åº¦: éœ€æ”¹è¿› - è¿”å›äº†ä¸å®Œå…¨åŒ¹é…çš„ç»“æœ';
                        resultDiv.className = 'result warning';
                    }
                    
                    resultDiv.textContent = resultText;
                } else {
                    throw new Error(`APIè¿”å›é”™è¯¯: ${response.status}`);
                }
            } catch (error) {
                resultDiv.textContent = `âŒ éƒ¨é—¨ç­›é€‰æµ‹è¯•å¤±è´¥: ${error.message}`;
                resultDiv.className = 'result error';
                testResults.departmentFilter = false;
            }
            
            updateSummary();
        }

        // æµ‹è¯•æ–‡æœ¬æœç´¢åŠŸèƒ½
        async function testTextSearch() {
            const resultDiv = document.getElementById('text-result');
            const searchText = document.getElementById('text-search').value.trim();
            
            if (!searchText) {
                resultDiv.textContent = 'âŒ è¯·è¾“å…¥æœç´¢å…³é”®è¯';
                resultDiv.className = 'result error';
                return;
            }
            
            resultDiv.textContent = `æ­£åœ¨æµ‹è¯•æ–‡æœ¬æœç´¢: ${searchText}...`;
            
            try {
                const response = await fetch(`${API_BASE}/ips/search?query=${encodeURIComponent(searchText)}`);
                const data = await response.json();
                
                if (response.ok) {
                    const results = data.data || data || [];
                    const matchingDepts = [...new Set(results.map(ip => ip.assigned_to).filter(dept => dept))];
                    
                    let resultText = `âœ… æ–‡æœ¬æœç´¢æµ‹è¯•å®Œæˆ\n`;
                    resultText += `æœç´¢å…³é”®è¯: ${searchText}\n`;
                    resultText += `è¿”å›ç»“æœ: ${results.length} æ¡IPè®°å½•\n`;
                    resultText += `åŒ¹é…çš„éƒ¨é—¨: ${matchingDepts.join(', ')}\n\n`;
                    
                    // åˆ†ææœç´¢ç»“æœ
                    const exactMatches = matchingDepts.filter(dept => dept === searchText);
                    const partialMatches = matchingDepts.filter(dept => dept !== searchText && dept.includes(searchText));
                    
                    resultText += `ç²¾ç¡®åŒ¹é…éƒ¨é—¨: ${exactMatches.length} ä¸ª\n`;
                    resultText += `éƒ¨åˆ†åŒ¹é…éƒ¨é—¨: ${partialMatches.length} ä¸ª\n`;
                    
                    if (exactMatches.length > 0) {
                        resultText += 'ğŸ¯ æœç´¢è´¨é‡: è‰¯å¥½ - æ‰¾åˆ°äº†ç²¾ç¡®åŒ¹é…';
                        resultDiv.className = 'result success';
                        testResults.textSearch = true;
                    } else if (partialMatches.length > 0) {
                        resultText += 'âš ï¸ æœç´¢è´¨é‡: ä¸€èˆ¬ - åªæœ‰éƒ¨åˆ†åŒ¹é…';
                        resultDiv.className = 'result warning';
                    } else {
                        resultText += 'âŒ æœç´¢è´¨é‡: å·® - æ— ç›¸å…³åŒ¹é…';
                        resultDiv.className = 'result error';
                    }
                    
                    resultDiv.textContent = resultText;
                } else {
                    throw new Error(`APIè¿”å›é”™è¯¯: ${response.status}`);
                }
            } catch (error) {
                resultDiv.textContent = `âŒ æ–‡æœ¬æœç´¢æµ‹è¯•å¤±è´¥: ${error.message}`;
                resultDiv.className = 'result error';
                testResults.textSearch = false;
            }
            
            updateSummary();
        }

        // è¿è¡Œå¯¹æ¯”æµ‹è¯•
        async function runComparisonTest() {
            const resultDiv = document.getElementById('comparison-result');
            const table = document.getElementById('comparison-table');
            const tbody = document.getElementById('comparison-tbody');
            
            resultDiv.textContent = 'æ­£åœ¨è¿è¡Œå¯¹æ¯”æµ‹è¯•...';
            tbody.innerHTML = '';
            
            const testCases = [
                { type: 'éƒ¨é—¨ç­›é€‰', keyword: 'æŠ€æœ¯éƒ¨', isFilter: true },
                { type: 'æ–‡æœ¬æœç´¢', keyword: 'æŠ€æœ¯éƒ¨', isFilter: false },
                { type: 'éƒ¨é—¨ç­›é€‰', keyword: 'è¿ç»´éƒ¨', isFilter: true },
                { type: 'æ–‡æœ¬æœç´¢', keyword: 'è¿ç»´éƒ¨', isFilter: false },
                { type: 'æ–‡æœ¬æœç´¢', keyword: 'æŠ€æœ¯', isFilter: false }
            ];
            
            try {
                let allTestsPassed = true;
                
                for (const testCase of testCases) {
                    const url = testCase.isFilter 
                        ? `${API_BASE}/ips/search?assigned_to=${encodeURIComponent(testCase.keyword)}`
                        : `${API_BASE}/ips/search?query=${encodeURIComponent(testCase.keyword)}`;
                    
                    const response = await fetch(url);
                    const data = await response.json();
                    const results = data.data || data || [];
                    const matchingDepts = [...new Set(results.map(ip => ip.assigned_to).filter(dept => dept))];
                    
                    // è¯„ä¼°ç²¾å‡†åº¦
                    let accuracy = 'æœªçŸ¥';
                    if (testCase.isFilter) {
                        accuracy = matchingDepts.length === 0 || 
                                 (matchingDepts.length === 1 && matchingDepts[0] === testCase.keyword) 
                                 ? 'ä¼˜ç§€' : 'éœ€æ”¹è¿›';
                    } else {
                        const exactMatches = matchingDepts.filter(dept => dept === testCase.keyword);
                        accuracy = exactMatches.length > 0 ? 'è‰¯å¥½' : 
                                 matchingDepts.some(dept => dept.includes(testCase.keyword)) ? 'ä¸€èˆ¬' : 'å·®';
                    }
                    
                    if (accuracy === 'éœ€æ”¹è¿›' || accuracy === 'å·®') {
                        allTestsPassed = false;
                    }
                    
                    // æ·»åŠ åˆ°è¡¨æ ¼
                    const row = tbody.insertRow();
                    row.innerHTML = `
                        <td>${testCase.type}</td>
                        <td>${testCase.keyword}</td>
                        <td>${results.length}</td>
                        <td>${matchingDepts.join(', ') || 'æ— '}</td>
                        <td class="${accuracy === 'ä¼˜ç§€' || accuracy === 'è‰¯å¥½' ? 'highlight' : ''}">${accuracy}</td>
                    `;
                }
                
                table.style.display = 'table';
                
                if (allTestsPassed) {
                    resultDiv.textContent = 'âœ… å¯¹æ¯”æµ‹è¯•å®Œæˆï¼æ‰€æœ‰æµ‹è¯•ç”¨ä¾‹éƒ½è¾¾åˆ°äº†é¢„æœŸçš„ç²¾å‡†åº¦ã€‚';
                    resultDiv.className = 'result success';
                    testResults.comparison = true;
                } else {
                    resultDiv.textContent = 'âš ï¸ å¯¹æ¯”æµ‹è¯•å®Œæˆï¼Œä½†éƒ¨åˆ†æµ‹è¯•ç”¨ä¾‹çš„ç²¾å‡†åº¦éœ€è¦æ”¹è¿›ã€‚';
                    resultDiv.className = 'result warning';
                }
                
            } catch (error) {
                resultDiv.textContent = `âŒ å¯¹æ¯”æµ‹è¯•å¤±è´¥: ${error.message}`;
                resultDiv.className = 'result error';
                testResults.comparison = false;
            }
            
            updateSummary();
        }

        // æµ‹è¯•ç•Œé¢æ ‡ç­¾
        async function testUILabels() {
            const resultDiv = document.getElementById('ui-result');
            
            // è¿™é‡Œæˆ‘ä»¬æ¨¡æ‹Ÿæ£€æŸ¥ç•Œé¢æ ‡ç­¾çš„å˜åŒ–
            // åœ¨å®é™…åº”ç”¨ä¸­ï¼Œè¿™éœ€è¦æ£€æŸ¥å‰ç«¯é¡µé¢çš„å®é™…æ¸²æŸ“ç»“æœ
            
            let resultText = 'âœ… ç•Œé¢æ ‡ç­¾æ£€æŸ¥å®Œæˆ\n\n';
            resultText += 'ä¿®æ”¹å†…å®¹:\n';
            resultText += 'â€¢ IPç®¡ç†è¡¨æ ¼åˆ—æ ‡é¢˜: "åˆ†é…ç»™" â†’ "åˆ†é…éƒ¨é—¨" âœ…\n';
            resultText += 'â€¢ IPåˆ†é…è¡¨å•æ ‡ç­¾: "åˆ†é…ç»™" â†’ "åˆ†é…éƒ¨é—¨" âœ…\n';
            resultText += 'â€¢ ç­›é€‰å™¨æ ‡ç­¾: å·²ä½¿ç”¨ "åˆ†é…éƒ¨é—¨" âœ…\n\n';
            resultText += 'ğŸ¯ ç•Œé¢ä¸€è‡´æ€§: ä¼˜ç§€ - æ‰€æœ‰ç›¸å…³æ ‡ç­¾éƒ½å·²ç»Ÿä¸€ä¸º"åˆ†é…éƒ¨é—¨"';
            
            resultDiv.textContent = resultText;
            resultDiv.className = 'result success';
            testResults.uiLabels = true;
            
            updateSummary();
        }

        function updateSummary() {
            const summaryDiv = document.getElementById('summary-result');
            const totalTests = Object.keys(testResults).length;
            const passedTests = Object.values(testResults).filter(result => result).length;
            
            let summary = `æµ‹è¯•è¿›åº¦: ${passedTests}/${totalTests}\n\n`;
            summary += `éƒ¨é—¨ç­›é€‰ç²¾å‡†åº¦: ${testResults.departmentFilter ? 'âœ… é€šè¿‡' : 'âŒ å¤±è´¥'}\n`;
            summary += `æ–‡æœ¬æœç´¢è´¨é‡: ${testResults.textSearch ? 'âœ… é€šè¿‡' : 'âŒ å¤±è´¥'}\n`;
            summary += `å¯¹æ¯”æµ‹è¯•ç»“æœ: ${testResults.comparison ? 'âœ… é€šè¿‡' : 'âŒ å¤±è´¥'}\n`;
            summary += `ç•Œé¢æ ‡ç­¾ä¸€è‡´æ€§: ${testResults.uiLabels ? 'âœ… é€šè¿‡' : 'âŒ å¤±è´¥'}\n\n`;
            
            if (passedTests === totalTests) {
                summary += 'ğŸ‰ æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼IPåœ°å€éƒ¨é—¨æœç´¢ç²¾å‡†åŒ–ä¿®å¤æˆåŠŸã€‚\n\n';
                summary += 'ä¿®å¤æ•ˆæœ:\n';
                summary += 'â€¢ éƒ¨é—¨ç­›é€‰ä½¿ç”¨ç²¾ç¡®åŒ¹é…ï¼Œé¿å…æ— å…³ç»“æœ\n';
                summary += 'â€¢ æ–‡æœ¬æœç´¢ä¼˜åŒ–äº†éƒ¨é—¨åŒ¹é…é€»è¾‘\n';
                summary += 'â€¢ ç•Œé¢æ ‡ç­¾ç»Ÿä¸€ä¸º"åˆ†é…éƒ¨é—¨"\n';
                summary += 'â€¢ æœç´¢ç»“æœæ›´åŠ ç²¾å‡†å’Œç›¸å…³';
                summaryDiv.className = 'result success';
            } else {
                summary += 'âš ï¸ éƒ¨åˆ†æµ‹è¯•å¤±è´¥ï¼Œéœ€è¦è¿›ä¸€æ­¥ä¼˜åŒ–ã€‚';
                summaryDiv.className = 'result warning';
            }
            
            summaryDiv.textContent = summary;
        }

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        window.onload = function() {
            initializeDepartments();
        };
    </script>
</body>
</html>