<!DOCTYPE html>
<html>
<head>
    <title>xiaobang登录诊断</title>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-result { margin: 10px 0; padding: 10px; border: 1px solid #ccc; }
        .success { background-color: #d4edda; border-color: #c3e6cb; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; }
        .info { background-color: #d1ecf1; border-color: #bee5eb; }
    </style>
</head>
<body>
    <h1>xiaobang用户登录诊断工具</h1>
    
    <button onclick="runAllTests()">运行所有测试</button>
    <button onclick="clearResults()">清除结果</button>
    
    <div id="results"></div>

    <script>
        const resultsDiv = document.getElementById('results');
        
        function addResult(message, type = 'info') {
            const div = document.createElement('div');
            div.className = `test-result ${type}`;
            div.innerHTML = message;
            resultsDiv.appendChild(div);
        }
        
        function clearResults() {
            resultsDiv.innerHTML = '';
        }
        
        async function testDirectLogin() {
            addResult('🔍 测试直接登录API...', 'info');
            
            try {
                const response = await axios.post('/api/auth/login', {
                    username: 'xiaobang',
                    password: 'xiaobang'
                });
                
                addResult(`✅ 直接API登录成功！<br>
                    状态码: ${response.status}<br>
                    用户: ${JSON.stringify(response.data.user)}<br>
                    令牌: ${response.data.access_token.substring(0, 50)}...`, 'success');
                
                return response.data;
            } catch (error) {
                addResult(`❌ 直接API登录失败！<br>
                    状态码: ${error.response?.status || 'N/A'}<br>
                    错误: ${error.response?.data?.detail || error.message}`, 'error');
                return null;
            }
        }
        
        async function testWrongPassword() {
            addResult('🔍 测试错误密码...', 'info');
            
            try {
                const response = await axios.post('/api/auth/login', {
                    username: 'xiaobang',
                    password: 'wrong_password'
                });
                
                addResult('❌ 错误密码竟然登录成功了！这是安全漏洞！', 'error');
            } catch (error) {
                if (error.response?.status === 401) {
                    addResult('✅ 错误密码被正确拒绝', 'success');
                } else {
                    addResult(`❓ 意外的错误响应: ${error.response?.status} - ${error.response?.data?.detail}`, 'error');
                }
            }
        }
        
        async function testAdminLogin() {
            addResult('🔍 测试admin用户登录...', 'info');
            
            try {
                const response = await axios.post('/api/auth/login', {
                    username: 'admin',
                    password: 'admin'
                });
                
                addResult(`✅ admin用户登录成功！<br>
                    用户: ${JSON.stringify(response.data.user)}`, 'success');
            } catch (error) {
                addResult(`❌ admin用户登录失败: ${error.response?.data?.detail || error.message}`, 'error');
            }
        }
        
        function checkLocalStorage() {
            addResult('🔍 检查本地存储...', 'info');
            
            const accessToken = localStorage.getItem('access_token');
            const refreshToken = localStorage.getItem('refresh_token');
            const user = localStorage.getItem('user');
            
            addResult(`本地存储状态:<br>
                访问令牌: ${accessToken ? '存在' : '不存在'}<br>
                刷新令牌: ${refreshToken ? '存在' : '不存在'}<br>
                用户信息: ${user ? '存在' : '不存在'}`, 'info');
            
            if (user) {
                try {
                    const userData = JSON.parse(user);
                    addResult(`当前用户: ${JSON.stringify(userData)}`, 'info');
                } catch (e) {
                    addResult('用户数据解析失败', 'error');
                }
            }
        }
        
        function clearLocalStorage() {
            addResult('🧹 清除本地存储...', 'info');
            localStorage.removeItem('access_token');
            localStorage.removeItem('refresh_token');
            localStorage.removeItem('user');
            addResult('✅ 本地存储已清除', 'success');
        }
        
        async function runAllTests() {
            clearResults();
            addResult('🚀 开始运行诊断测试...', 'info');
            
            // 检查本地存储
            checkLocalStorage();
            
            // 清除本地存储
            clearLocalStorage();
            
            // 测试登录
            await testDirectLogin();
            await testWrongPassword();
            await testAdminLogin();
            
            addResult('✅ 所有测试完成！', 'success');
        }
        
        // 页面加载时显示说明
        window.onload = function() {
            addResult('📋 这个工具将帮助诊断xiaobang用户的登录问题', 'info');
            addResult('💡 建议：先清除浏览器缓存，然后运行测试', 'info');
        };
    </script>
</body>
</html>