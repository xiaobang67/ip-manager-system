import{_ as de,k as ue,l as d,n as q,q as P,J as B,t as ie,r as u,v as me,o as D,z as h,w as l,E as g,b as c,N,f,d as $,a as t,y as pe,x as ce,M as fe,G as ve,B as ge,j as _e}from"./index-37bb85c5-1758196715214.js";import{A as ye}from"./AppLayout-1ceae357-1758196715485.js";import{getDepartments as we,createDepartment as be,updateDepartment as xe,deleteDepartment as Ce}from"./departments-39383521-1758196715485.js";const Ve={class:"department-management"},De={class:"page-header"},he={class:"header-right"},ke={class:"pagination-wrapper"},ze={class:"dialog-footer"},Fe={class:"dialog-footer"},Ue={__name:"DepartmentManagement",setup(Me){const j=ue(),z=d(!1),w=d([]);d(null);const b=d(""),v=d(1),x=d(20),C=d(0),_=d(!1),y=d(!1),F=d(!1),U=d(!1),M=d(),S=d(),A=d(null),i=q({name:"",code:""}),m=q({name:"",code:""}),G=P(()=>j.getters["auth/userRole"]),R=P(()=>{var e;const a=(e=G.value)==null?void 0:e.toLowerCase();return["admin","manager"].includes(a)}),J={name:[{required:!0,message:"请输入部门名称",trigger:"blur"},{min:1,max:100,message:"部门名称长度在 1 到 100 个字符",trigger:"blur"}],code:[{max:50,message:"部门编码长度不能超过 50 个字符",trigger:"blur"}]},Q={name:[{required:!0,message:"请输入部门名称",trigger:"blur"},{min:1,max:100,message:"部门名称长度在 1 到 100 个字符",trigger:"blur"}],code:[{max:50,message:"部门编码长度不能超过 50 个字符",trigger:"blur"}]},p=async()=>{var a,e,r;try{z.value=!0;const n={skip:(v.value-1)*x.value,limit:x.value,search:b.value||void 0},s=await we(n);s&&s.departments?(w.value=s.departments,C.value=s.total||0):Array.isArray(s)?(w.value=s,C.value=s.length):(w.value=[],C.value=0)}catch(n){console.error("加载部门列表失败:",n),w.value=[],C.value=0;let s="加载部门列表失败";n.response?n.response.status===404?s="API端点不存在，请检查后端服务":n.response.status===401?s="认证失败，请重新登录":n.response.status===403?s="权限不足，无法访问组织管理":(a=n.response.data)!=null&&a.detail?s=n.response.data.detail:(r=(e=n.response.data)==null?void 0:e.error)!=null&&r.message&&(s=n.response.data.error.message):n.message&&(s=n.message),g.error(s)}finally{z.value=!1}},H=()=>{v.value=1,p()},K=()=>{b.value="",v.value=1,p()},O=({prop:a,order:e})=>{},W=a=>{x.value=a,v.value=1,p()},X=a=>{v.value=a,p()},Y=a=>{A.value=a,m.name=a.name,m.code=a.code||"",y.value=!0},Z=async()=>{var a,e;try{if(!await M.value.validate())return;F.value=!0,await be({name:i.name,code:i.code||void 0}),g.success("部门创建成功"),_.value=!1,E(),p()}catch(r){console.error("创建部门失败:",r),g.error(((e=(a=r.response)==null?void 0:a.data)==null?void 0:e.detail)||"创建部门失败")}finally{F.value=!1}},ee=async()=>{var a,e;try{if(!await S.value.validate())return;U.value=!0,await xe(A.value.id,{name:m.name,code:m.code||void 0}),g.success("部门更新成功"),y.value=!1,p()}catch(r){console.error("更新部门失败:",r),g.error(((e=(a=r.response)==null?void 0:a.data)==null?void 0:e.detail)||"更新部门失败")}finally{U.value=!1}},ae=async a=>{var e,r;try{await fe.confirm(`确定要删除部门 "${a.name}" 吗？此操作不可恢复！`,"确认删除",{confirmButtonText:"删除",cancelButtonText:"取消",type:"error"}),await Ce(a.id),g.success("部门删除成功"),p()}catch(n){n!=="cancel"&&(console.error("删除部门失败:",n),g.error(((r=(e=n.response)==null?void 0:e.data)==null?void 0:r.detail)||"删除部门失败"))}},E=()=>{var a;i.name="",i.code="",(a=M.value)==null||a.resetFields()},te=a=>a?new Date(a).toLocaleString("zh-CN"):"-";return B([b],()=>{v.value=1,p()}),ie(async()=>{await p()}),B(_,a=>{a||E()}),B(y,a=>{var e;a||(e=S.value)==null||e.resetFields()}),(a,e)=>{const r=u("el-button"),n=u("el-input"),s=u("el-col"),le=u("el-row"),L=u("el-card"),V=u("el-table-column"),oe=u("el-table"),ne=u("el-pagination"),k=u("el-form-item"),I=u("el-form"),T=u("el-dialog"),re=me("loading");return D(),h(ye,null,{default:l(()=>[c("div",Ve,[c("div",De,[e[13]||(e[13]=c("div",{class:"header-left"},[c("h1",null,"组织管理"),c("p",{class:"page-description"},"管理系统部门信息和组织架构")],-1)),c("div",he,[R.value?(D(),h(r,{key:0,type:"primary",icon:N(ve),onClick:e[0]||(e[0]=o=>_.value=!0)},{default:l(()=>[...e[12]||(e[12]=[f(" 新建部门 ",-1)])]),_:1},8,["icon"])):$("",!0)])]),t(L,{class:"filter-card"},{default:l(()=>[t(le,{gutter:20},{default:l(()=>[t(s,{span:12},{default:l(()=>[t(n,{modelValue:b.value,"onUpdate:modelValue":e[1]||(e[1]=o=>b.value=o),placeholder:"搜索部门名称或编码","prefix-icon":N(ge),clearable:"",onInput:H},null,8,["modelValue","prefix-icon"])]),_:1}),t(s,{span:4},{default:l(()=>[t(r,{onClick:K,icon:N(_e)},{default:l(()=>[...e[14]||(e[14]=[f("重置",-1)])]),_:1},8,["icon"])]),_:1})]),_:1})]),_:1}),t(L,{class:"table-card"},{default:l(()=>[pe((D(),h(oe,{data:w.value,stripe:"",style:{width:"100%"},onSortChange:O},{default:l(()=>[t(V,{prop:"id",label:"ID",width:"80",sortable:""}),t(V,{prop:"name",label:"部门名称","min-width":"200",sortable:""}),t(V,{prop:"code",label:"部门编码",width:"150"}),t(V,{prop:"created_at",label:"创建时间",width:"180",sortable:""},{default:l(({row:o})=>[f(ce(te(o.created_at)),1)]),_:1}),t(V,{label:"操作",width:"150",fixed:"right"},{default:l(({row:o})=>[R.value?(D(),h(r,{key:0,size:"small",type:"primary",onClick:se=>Y(o)},{default:l(()=>[...e[15]||(e[15]=[f(" 编辑 ",-1)])]),_:2},1032,["onClick"])):$("",!0),R.value?(D(),h(r,{key:1,size:"small",type:"danger",plain:"",onClick:se=>ae(o)},{default:l(()=>[...e[16]||(e[16]=[f(" 删除 ",-1)])]),_:2},1032,["onClick"])):$("",!0)]),_:1})]),_:1},8,["data"])),[[re,z.value]]),c("div",ke,[t(ne,{"current-page":v.value,"onUpdate:currentPage":e[2]||(e[2]=o=>v.value=o),"page-size":x.value,"onUpdate:pageSize":e[3]||(e[3]=o=>x.value=o),"page-sizes":[10,20,50,100],total:C.value,layout:"total, sizes, prev, pager, next, jumper",onSizeChange:W,onCurrentChange:X},null,8,["current-page","page-size","total"])])]),_:1}),t(T,{modelValue:_.value,"onUpdate:modelValue":e[7]||(e[7]=o=>_.value=o),title:"创建新部门",width:"600px","close-on-click-modal":!1},{footer:l(()=>[c("span",ze,[t(r,{onClick:e[6]||(e[6]=o=>_.value=!1)},{default:l(()=>[...e[17]||(e[17]=[f("取消",-1)])]),_:1}),t(r,{type:"primary",onClick:Z,loading:F.value},{default:l(()=>[...e[18]||(e[18]=[f(" 创建 ",-1)])]),_:1},8,["loading"])])]),default:l(()=>[t(I,{ref_key:"createFormRef",ref:M,model:i,rules:J,"label-width":"100px"},{default:l(()=>[t(k,{label:"部门名称",prop:"name"},{default:l(()=>[t(n,{modelValue:i.name,"onUpdate:modelValue":e[4]||(e[4]=o=>i.name=o),placeholder:"请输入部门名称",maxlength:"100","show-word-limit":""},null,8,["modelValue"])]),_:1}),t(k,{label:"部门编码",prop:"code"},{default:l(()=>[t(n,{modelValue:i.code,"onUpdate:modelValue":e[5]||(e[5]=o=>i.code=o),placeholder:"请输入部门编码（可选）",maxlength:"50"},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"]),t(T,{modelValue:y.value,"onUpdate:modelValue":e[11]||(e[11]=o=>y.value=o),title:"编辑部门",width:"600px","close-on-click-modal":!1},{footer:l(()=>[c("span",Fe,[t(r,{onClick:e[10]||(e[10]=o=>y.value=!1)},{default:l(()=>[...e[19]||(e[19]=[f("取消",-1)])]),_:1}),t(r,{type:"primary",onClick:ee,loading:U.value},{default:l(()=>[...e[20]||(e[20]=[f(" 更新 ",-1)])]),_:1},8,["loading"])])]),default:l(()=>[t(I,{ref_key:"editFormRef",ref:S,model:m,rules:Q,"label-width":"100px"},{default:l(()=>[t(k,{label:"部门名称",prop:"name"},{default:l(()=>[t(n,{modelValue:m.name,"onUpdate:modelValue":e[8]||(e[8]=o=>m.name=o),placeholder:"请输入部门名称",maxlength:"100","show-word-limit":""},null,8,["modelValue"])]),_:1}),t(k,{label:"部门编码",prop:"code"},{default:l(()=>[t(n,{modelValue:m.code,"onUpdate:modelValue":e[9]||(e[9]=o=>m.code=o),placeholder:"请输入部门编码（可选）",maxlength:"50"},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"])])]),_:1})}}},Ne=de(Ue,[["__scopeId","data-v-43c1f7ff"]]);export{Ne as default};
