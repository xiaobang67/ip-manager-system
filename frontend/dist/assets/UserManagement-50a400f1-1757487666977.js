import{_ as qe,I as Be,f as m,g as se,h as K,i as re,j as Ee,r as p,J as Me,o as f,p as b,w as s,E as w,a as u,U as R,e as c,u as M,c as I,b as t,t as U,q as O,F as Q,K as Ie,T as pe,O as Ne,D as je,V as Je,W as Ke,X as Oe,M as Qe,A as We}from"./index-9c6477ff-1757487666975.js";import{A as Xe}from"./AppLayout-bae8690e-1757487667213.js";import{g as Ge,a as He,b as Ye,c as Ze,d as ea,u as aa,r as la,t as ta,e as sa}from"./users-3bb63c9f-1757487667219.js";import"./ThemeToggle-d445fee0-1757487667116.js";const ra={class:"user-management"},oa={class:"page-header"},na={class:"header-right"},ua={key:0,class:"stats-cards"},ia={class:"stat-content"},da={class:"stat-number"},ma={class:"stat-content"},pa={class:"stat-number"},ca={class:"stat-content"},va={class:"stat-number"},fa={class:"stat-content"},ga={class:"stat-number"},_a={class:"pagination-wrapper"},wa={class:"dialog-footer"},ya={class:"dialog-footer"},ba={class:"dialog-footer"},Va={__name:"UserManagement",setup(ha){const oe=Be(),W=m(!1),N=m([]),F=m(null),C=m([]),z=m([]),L=m(""),S=m(""),A=m(""),k=m(1),$=m(20),j=m(0),T=m(!1),q=m(!1),D=m(!1),X=m(!1),G=m(!1),H=m(!1),Y=m(),ne=m(),Z=m(),ee=m(null),i=se({username:"",password:"",confirmPassword:"",email:"",role:"user"}),d=se({username:"",email:"",role:"",theme:"",is_active:!0}),_=se({new_password:"",confirmPassword:""}),ue=K(()=>{var a;return(a=oe.getters["auth/currentUser"])==null?void 0:a.id}),ie=K(()=>oe.getters["auth/userRole"]),J=K(()=>{var e;const a=(e=ie.value)==null?void 0:e.toLowerCase();return["admin","manager"].includes(a)}),ce=K(()=>{let a=N.value;if(L.value){const e=L.value.toLowerCase();a=a.filter(r=>r.username.toLowerCase().includes(e)||r.email&&r.email.toLowerCase().includes(e))}return A.value&&(A.value==="active"?a=a.filter(e=>e.is_active):A.value==="inactive"&&(a=a.filter(e=>!e.is_active))),a}),ve={username:[{required:!0,message:"请输入用户名",trigger:"blur"},{min:3,max:50,message:"用户名长度在 3 到 50 个字符",trigger:"blur"}],password:[{required:!0,message:"请输入密码",trigger:"blur"},{min:8,message:"密码长度不能少于 8 个字符",trigger:"blur"}],confirmPassword:[{required:!0,message:"请确认密码",trigger:"blur"},{validator:(a,e,r)=>{e!==i.password?r(new Error("两次输入密码不一致")):r()},trigger:"blur"}],email:[{type:"email",message:"请输入正确的邮箱地址",trigger:"blur"}],role:[{required:!0,message:"请选择用户角色",trigger:"change"}]},fe={username:[{required:!0,message:"请输入用户名",trigger:"blur"},{min:3,max:50,message:"用户名长度在 3 到 50 个字符",trigger:"blur"}],email:[{type:"email",message:"请输入正确的邮箱地址",trigger:"blur"}],role:[{required:!0,message:"请选择用户角色",trigger:"change"}]},ge={new_password:[{required:!0,message:"请输入新密码",trigger:"blur"},{min:8,message:"密码长度不能少于 8 个字符",trigger:"blur"}],confirmPassword:[{required:!0,message:"请确认密码",trigger:"blur"},{validator:(a,e,r)=>{e!==_.new_password?r(new Error("两次输入密码不一致")):r()},trigger:"blur"}]},y=async()=>{var a,e,r;try{W.value=!0;const n={skip:(k.value-1)*$.value,limit:$.value,active_only:!1};S.value&&(n.role_filter=S.value);const o=await Ge(n);if(!o){N.value=[],j.value=0;return}let v=[],V=0;o.users&&Array.isArray(o.users)?(v=o.users,V=o.total||0):(a=o.data)!=null&&a.users&&Array.isArray(o.data.users)?(v=o.data.users,V=o.data.total||0):Array.isArray(o)?(v=o,V=o.length):o.data&&Array.isArray(o.data)?(v=o.data,V=o.data.length):(v=[],V=0),N.value=v,j.value=V}catch(n){console.error("加载用户列表失败:",n),N.value=[],j.value=0,w.error("加载用户列表失败: "+(((r=(e=n.response)==null?void 0:e.data)==null?void 0:r.detail)||n.message))}finally{W.value=!1}},B=async()=>{var a;try{((a=ie.value)==null?void 0:a.toLowerCase())==="admin"&&(F.value=await He())}catch(e){console.error("加载统计信息失败:",e)}},_e=async()=>{try{const a=await Ye();Array.isArray(a)?C.value=a:a.roles&&Array.isArray(a.roles)?C.value=a.roles:a.data&&Array.isArray(a.data)?C.value=a.data:C.value=[]}catch(a){console.error("加载角色列表失败:",a),C.value=[]}},we=async()=>{try{const a=await Ze();Array.isArray(a)?z.value=a:a.themes&&Array.isArray(a.themes)?z.value=a.themes:a.data&&Array.isArray(a.data)?z.value=a.data:z.value=[]}catch(a){console.error("加载主题列表失败:",a),z.value=[]}},ye=()=>{k.value=1},be=()=>{L.value="",S.value="",A.value="",k.value=1,y()},Ve=({prop:a,order:e})=>{},he=a=>{$.value=a,k.value=1,y()},Ue=a=>{k.value=a,y()},Ce=a=>{ee.value=a,d.username=a.username,d.email=a.email||"",d.role=a.role,d.theme=a.theme,d.is_active=a.is_active,q.value=!0},ke=async()=>{var a,e;try{if(!await Y.value.validate())return;X.value=!0,await ea({username:i.username,password:i.password,email:i.email||void 0,role:i.role}),w.success("用户创建成功"),T.value=!1,de(),y(),B()}catch(r){console.error("创建用户失败:",r),w.error(((e=(a=r.response)==null?void 0:a.data)==null?void 0:e.detail)||"创建用户失败")}finally{X.value=!1}},xe=async()=>{var a,e;try{if(!await ne.value.validate())return;G.value=!0,await aa(ee.value.id,{username:d.username,email:d.email||void 0,role:d.role,theme:d.theme,is_active:d.is_active}),w.success("用户更新成功"),q.value=!1,y(),B()}catch(r){console.error("更新用户失败:",r),w.error(((e=(a=r.response)==null?void 0:a.data)==null?void 0:e.detail)||"更新用户失败")}finally{G.value=!1}},Ae=async()=>{var a,e;try{if(!await Z.value.validate())return;H.value=!0,await la(ee.value.id,{new_password:_.new_password}),w.success("密码重置成功"),D.value=!1,_.new_password="",_.confirmPassword=""}catch(r){console.error("重置密码失败:",r),w.error(((e=(a=r.response)==null?void 0:a.data)==null?void 0:e.detail)||"重置密码失败")}finally{H.value=!1}},Pe=async a=>{var e,r;try{const n=a.is_active?"停用":"启用";await pe.confirm(`确定要${n}用户 "${a.username}" 吗？`,"确认操作",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}),await ta(a.id),w.success(`用户${n}成功`),y(),B()}catch(n){n!=="cancel"&&(console.error("切换用户状态失败:",n),w.error(((r=(e=n.response)==null?void 0:e.data)==null?void 0:r.detail)||"操作失败"))}},Re=async a=>{var e,r;try{await pe.confirm(`确定要删除用户 "${a.username}" 吗？此操作不可恢复！`,"确认删除",{confirmButtonText:"删除",cancelButtonText:"取消",type:"error"}),await sa(a.id),w.success("用户删除成功"),y(),B()}catch(n){n!=="cancel"&&(console.error("删除用户失败:",n),w.error(((r=(e=n.response)==null?void 0:e.data)==null?void 0:r.detail)||"删除用户失败"))}},de=()=>{var a;i.username="",i.password="",i.confirmPassword="",i.email="",i.role="user",(a=Y.value)==null||a.resetFields()},Fe=a=>({admin:"danger",manager:"warning",user:"info"})[a]||"info",ze=a=>({admin:"管理员",manager:"经理",user:"普通用户"})[a]||a,Se=a=>a?new Date(a).toLocaleString("zh-CN"):"-";return re([S,A],()=>{k.value=1}),Ee(async()=>{await Promise.all([y(),B(),_e(),we()])}),re(T,a=>{a||de()}),re(D,a=>{var e;a||(_.new_password="",_.confirmPassword="",(e=Z.value)==null||e.resetFields())}),(a,e)=>{const r=p("el-button"),n=p("el-icon"),o=p("el-card"),v=p("el-col"),V=p("el-row"),h=p("el-input"),P=p("el-option"),E=p("el-select"),x=p("el-table-column"),ae=p("el-tag"),Te=p("el-table"),De=p("el-pagination"),g=p("el-form-item"),le=p("el-form"),te=p("el-dialog"),Le=p("el-switch"),$e=Me("loading");return f(),b(Xe,null,{default:s(()=>[u("div",ra,[u("div",oa,[e[26]||(e[26]=u("div",{class:"header-left"},[u("h1",null,"用户管理"),u("p",{class:"page-description"},"管理系统用户账号和权限")],-1)),u("div",na,[J.value?(f(),b(r,{key:0,type:"primary",icon:R(Ne),onClick:e[0]||(e[0]=l=>T.value=!0)},{default:s(()=>[...e[25]||(e[25]=[c(" 新建用户 ",-1)])]),_:1},8,["icon"])):M("",!0)])]),F.value?(f(),I("div",ua,[t(V,{gutter:20},{default:s(()=>[t(v,{span:6},{default:s(()=>[t(o,{class:"stat-card"},{default:s(()=>[u("div",ia,[u("div",da,U(F.value.total_users),1),e[27]||(e[27]=u("div",{class:"stat-label"},"总用户数",-1))]),t(n,{class:"stat-icon"},{default:s(()=>[t(R(je))]),_:1})]),_:1})]),_:1}),t(v,{span:6},{default:s(()=>[t(o,{class:"stat-card"},{default:s(()=>[u("div",ma,[u("div",pa,U(F.value.active_users),1),e[28]||(e[28]=u("div",{class:"stat-label"},"活跃用户",-1))]),t(n,{class:"stat-icon active"},{default:s(()=>[t(R(Je))]),_:1})]),_:1})]),_:1}),t(v,{span:6},{default:s(()=>[t(o,{class:"stat-card"},{default:s(()=>{var l;return[u("div",ca,[u("div",va,U(((l=F.value.role_distribution)==null?void 0:l.admin)||0),1),e[29]||(e[29]=u("div",{class:"stat-label"},"管理员",-1))]),t(n,{class:"stat-icon admin"},{default:s(()=>[t(R(Ke))]),_:1})]}),_:1})]),_:1}),t(v,{span:6},{default:s(()=>[t(o,{class:"stat-card"},{default:s(()=>[u("div",fa,[u("div",ga,U(F.value.inactive_users),1),e[30]||(e[30]=u("div",{class:"stat-label"},"停用用户",-1))]),t(n,{class:"stat-icon inactive"},{default:s(()=>[t(R(Oe))]),_:1})]),_:1})]),_:1})]),_:1})])):M("",!0),t(o,{class:"filter-card"},{default:s(()=>[t(V,{gutter:20},{default:s(()=>[t(v,{span:8},{default:s(()=>[t(h,{modelValue:L.value,"onUpdate:modelValue":e[1]||(e[1]=l=>L.value=l),placeholder:"搜索用户名或邮箱","prefix-icon":R(Qe),clearable:"",onInput:ye},null,8,["modelValue","prefix-icon"])]),_:1}),t(v,{span:6},{default:s(()=>[t(E,{modelValue:S.value,"onUpdate:modelValue":e[2]||(e[2]=l=>S.value=l),placeholder:"选择角色",clearable:"",onChange:y},{default:s(()=>[(f(!0),I(Q,null,O(C.value,l=>(f(),b(P,{key:l.value,label:l.label,value:l.value},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),t(v,{span:6},{default:s(()=>[t(E,{modelValue:A.value,"onUpdate:modelValue":e[3]||(e[3]=l=>A.value=l),placeholder:"选择状态",clearable:"",onChange:y},{default:s(()=>[t(P,{label:"全部用户",value:""}),t(P,{label:"活跃用户",value:"active"}),t(P,{label:"停用用户",value:"inactive"})]),_:1},8,["modelValue"])]),_:1}),t(v,{span:4},{default:s(()=>[t(r,{onClick:be,icon:R(We)},{default:s(()=>[...e[31]||(e[31]=[c("重置",-1)])]),_:1},8,["icon"])]),_:1})]),_:1})]),_:1}),t(o,{class:"table-card"},{default:s(()=>[Ie((f(),b(Te,{data:ce.value,stripe:"",style:{width:"100%"},onSortChange:Ve},{default:s(()=>[t(x,{prop:"id",label:"ID",width:"80",sortable:""}),t(x,{prop:"username",label:"用户名","min-width":"120",sortable:""}),t(x,{prop:"email",label:"邮箱","min-width":"180"}),t(x,{prop:"role",label:"角色",width:"100"},{default:s(({row:l})=>[t(ae,{type:Fe(l.role),size:"small"},{default:s(()=>[c(U(ze(l.role)),1)]),_:2},1032,["type"])]),_:1}),t(x,{prop:"theme",label:"主题",width:"100"},{default:s(({row:l})=>[t(ae,{type:l.theme==="dark"?"info":"success",size:"small"},{default:s(()=>[c(U(l.theme==="dark"?"暗黑":"明亮"),1)]),_:2},1032,["type"])]),_:1}),t(x,{prop:"is_active",label:"状态",width:"100"},{default:s(({row:l})=>[t(ae,{type:l.is_active?"success":"danger",size:"small"},{default:s(()=>[c(U(l.is_active?"活跃":"停用"),1)]),_:2},1032,["type"])]),_:1}),t(x,{prop:"created_at",label:"创建时间",width:"180",sortable:""},{default:s(({row:l})=>[c(U(Se(l.created_at)),1)]),_:1}),t(x,{label:"操作",width:"200",fixed:"right"},{default:s(({row:l})=>[J.value?(f(),b(r,{key:0,size:"small",type:"primary",onClick:me=>Ce(l)},{default:s(()=>[...e[32]||(e[32]=[c(" 编辑 ",-1)])]),_:2},1032,["onClick"])):M("",!0),J.value&&l.id!==ue.value?(f(),b(r,{key:1,size:"small",type:l.is_active?"warning":"primary",onClick:me=>Pe(l)},{default:s(()=>[c(U(l.is_active?"停用":"启用"),1)]),_:2},1032,["type","onClick"])):M("",!0),J.value&&l.id!==ue.value?(f(),b(r,{key:2,size:"small",type:"danger",plain:"",onClick:me=>Re(l)},{default:s(()=>[...e[33]||(e[33]=[c(" 删除 ",-1)])]),_:2},1032,["onClick"])):M("",!0)]),_:1})]),_:1},8,["data"])),[[$e,W.value]]),u("div",_a,[t(De,{"current-page":k.value,"onUpdate:currentPage":e[4]||(e[4]=l=>k.value=l),"page-size":$.value,"onUpdate:pageSize":e[5]||(e[5]=l=>$.value=l),"page-sizes":[10,20,50,100],total:j.value,layout:"total, sizes, prev, pager, next, jumper",onSizeChange:he,onCurrentChange:Ue},null,8,["current-page","page-size","total"])])]),_:1}),t(te,{modelValue:T.value,"onUpdate:modelValue":e[12]||(e[12]=l=>T.value=l),title:"创建新用户",width:"500px","close-on-click-modal":!1},{footer:s(()=>[u("span",wa,[t(r,{onClick:e[11]||(e[11]=l=>T.value=!1)},{default:s(()=>[...e[34]||(e[34]=[c("取消",-1)])]),_:1}),t(r,{type:"primary",onClick:ke,loading:X.value},{default:s(()=>[...e[35]||(e[35]=[c(" 创建 ",-1)])]),_:1},8,["loading"])])]),default:s(()=>[t(le,{ref_key:"createFormRef",ref:Y,model:i,rules:ve,"label-width":"80px"},{default:s(()=>[t(g,{label:"用户名",prop:"username"},{default:s(()=>[t(h,{modelValue:i.username,"onUpdate:modelValue":e[6]||(e[6]=l=>i.username=l),placeholder:"请输入用户名",maxlength:"50","show-word-limit":""},null,8,["modelValue"])]),_:1}),t(g,{label:"密码",prop:"password"},{default:s(()=>[t(h,{modelValue:i.password,"onUpdate:modelValue":e[7]||(e[7]=l=>i.password=l),type:"password",placeholder:"请输入密码","show-password":"",maxlength:"128"},null,8,["modelValue"])]),_:1}),t(g,{label:"确认密码",prop:"confirmPassword"},{default:s(()=>[t(h,{modelValue:i.confirmPassword,"onUpdate:modelValue":e[8]||(e[8]=l=>i.confirmPassword=l),type:"password",placeholder:"请再次输入密码","show-password":"",maxlength:"128"},null,8,["modelValue"])]),_:1}),t(g,{label:"邮箱",prop:"email"},{default:s(()=>[t(h,{modelValue:i.email,"onUpdate:modelValue":e[9]||(e[9]=l=>i.email=l),placeholder:"请输入邮箱地址",maxlength:"100"},null,8,["modelValue"])]),_:1}),t(g,{label:"角色",prop:"role"},{default:s(()=>[t(E,{modelValue:i.role,"onUpdate:modelValue":e[10]||(e[10]=l=>i.role=l),placeholder:"请选择角色",style:{width:"100%"}},{default:s(()=>[(f(!0),I(Q,null,O(C.value,l=>(f(),b(P,{key:l.value,label:l.label,value:l.value},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"]),t(te,{modelValue:q.value,"onUpdate:modelValue":e[20]||(e[20]=l=>q.value=l),title:"编辑用户",width:"500px","close-on-click-modal":!1},{footer:s(()=>[u("span",ya,[t(r,{onClick:e[18]||(e[18]=l=>q.value=!1)},{default:s(()=>[...e[36]||(e[36]=[c("取消",-1)])]),_:1}),t(r,{type:"warning",onClick:e[19]||(e[19]=l=>D.value=!0)},{default:s(()=>[...e[37]||(e[37]=[c(" 重置密码 ",-1)])]),_:1}),t(r,{type:"primary",onClick:xe,loading:G.value},{default:s(()=>[...e[38]||(e[38]=[c(" 更新 ",-1)])]),_:1},8,["loading"])])]),default:s(()=>[t(le,{ref_key:"editFormRef",ref:ne,model:d,rules:fe,"label-width":"80px"},{default:s(()=>[t(g,{label:"用户名",prop:"username"},{default:s(()=>[t(h,{modelValue:d.username,"onUpdate:modelValue":e[13]||(e[13]=l=>d.username=l),placeholder:"请输入用户名",maxlength:"50","show-word-limit":""},null,8,["modelValue"])]),_:1}),t(g,{label:"邮箱",prop:"email"},{default:s(()=>[t(h,{modelValue:d.email,"onUpdate:modelValue":e[14]||(e[14]=l=>d.email=l),placeholder:"请输入邮箱地址",maxlength:"100"},null,8,["modelValue"])]),_:1}),t(g,{label:"角色",prop:"role"},{default:s(()=>[t(E,{modelValue:d.role,"onUpdate:modelValue":e[15]||(e[15]=l=>d.role=l),placeholder:"请选择角色",style:{width:"100%"}},{default:s(()=>[(f(!0),I(Q,null,O(C.value,l=>(f(),b(P,{key:l.value,label:l.label,value:l.value},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),t(g,{label:"主题",prop:"theme"},{default:s(()=>[t(E,{modelValue:d.theme,"onUpdate:modelValue":e[16]||(e[16]=l=>d.theme=l),placeholder:"请选择主题",style:{width:"100%"}},{default:s(()=>[(f(!0),I(Q,null,O(z.value,l=>(f(),b(P,{key:l.value,label:l.label,value:l.value},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),t(g,{label:"状态",prop:"is_active"},{default:s(()=>[t(Le,{modelValue:d.is_active,"onUpdate:modelValue":e[17]||(e[17]=l=>d.is_active=l),"active-text":"启用","inactive-text":"停用"},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"]),t(te,{modelValue:D.value,"onUpdate:modelValue":e[24]||(e[24]=l=>D.value=l),title:"重置密码",width:"400px","close-on-click-modal":!1},{footer:s(()=>[u("span",ba,[t(r,{onClick:e[23]||(e[23]=l=>D.value=!1)},{default:s(()=>[...e[39]||(e[39]=[c("取消",-1)])]),_:1}),t(r,{type:"primary",onClick:Ae,loading:H.value},{default:s(()=>[...e[40]||(e[40]=[c(" 重置 ",-1)])]),_:1},8,["loading"])])]),default:s(()=>[t(le,{ref_key:"resetPasswordFormRef",ref:Z,model:_,rules:ge,"label-width":"80px"},{default:s(()=>[t(g,{label:"新密码",prop:"new_password"},{default:s(()=>[t(h,{modelValue:_.new_password,"onUpdate:modelValue":e[21]||(e[21]=l=>_.new_password=l),type:"password",placeholder:"请输入新密码","show-password":"",maxlength:"128"},null,8,["modelValue"])]),_:1}),t(g,{label:"确认密码",prop:"confirmPassword"},{default:s(()=>[t(h,{modelValue:_.confirmPassword,"onUpdate:modelValue":e[22]||(e[22]=l=>_.confirmPassword=l),type:"password",placeholder:"请再次输入新密码","show-password":"",maxlength:"128"},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"])])]),_:1})}}},Aa=qe(Va,[["__scopeId","data-v-eefcc92e"]]);export{Aa as default};
