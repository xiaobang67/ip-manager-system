import{s as k,_ as Ee,k as Me,l as m,n as ne,q as H,J as ue,t as Ne,r as c,v as Ie,o as f,z as V,w as s,E as y,b as u,N as z,f as p,d as j,c as Q,a as t,x as C,C as K,F as W,y as je,M as ve,G as Qe,O as Ge,P as Je,Q as Oe,R as He,B as Ke,j as We}from"./index-37bb85c5-1758196715214.js";import{A as Xe}from"./AppLayout-1ceae357-1758196715485.js";function Ye(g={}){return k({url:"/users/",method:"get",params:g})}function Ze(){return k({url:"/users/statistics",method:"get"})}function ea(g){return k({url:"/users/",method:"post",data:g})}function aa(g,$){return k({url:`/users/${g}`,method:"put",data:$})}function la(g){return k({url:`/users/${g}`,method:"delete"})}function ta(g,$){return k({url:`/users/${g}/password`,method:"put",data:$})}function sa(g){return k({url:`/users/${g}/toggle-status`,method:"put"})}function ra(){return k({url:"/users/roles/available",method:"get"})}function oa(){return k({url:"/users/themes/available",method:"get"})}const na={class:"user-management"},ua={class:"page-header"},ia={class:"header-right"},da={key:0,class:"stats-cards"},ma={class:"stat-content"},ca={class:"stat-number"},pa={class:"stat-content"},va={class:"stat-number"},fa={class:"stat-content"},ga={class:"stat-number"},_a={class:"stat-content"},wa={class:"stat-number"},ya={class:"pagination-wrapper"},ba={class:"dialog-footer"},Va={class:"dialog-footer"},ha={class:"dialog-footer"},Ua={__name:"UserManagement",setup(g){const $=Me(),X=m(!1),G=m([]),S=m(null),x=m([]),L=m([]),B=m(""),T=m(""),R=m(""),A=m(1),E=m(20),J=m(0),D=m(!1),M=m(!1),q=m(!1),Y=m(!1),Z=m(!1),ee=m(!1),ae=m(),ie=m(),le=m(),te=m(null),i=ne({username:"",password:"",confirmPassword:"",email:"",role:"user"}),d=ne({username:"",email:"",role:"",theme:"",is_active:!0}),w=ne({new_password:"",confirmPassword:""}),de=H(()=>{var a;return(a=$.getters["auth/currentUser"])==null?void 0:a.id}),me=H(()=>$.getters["auth/userRole"]),O=H(()=>{var e;const a=(e=me.value)==null?void 0:e.toLowerCase();return["admin","manager"].includes(a)}),fe=H(()=>{let a=G.value;if(B.value){const e=B.value.toLowerCase();a=a.filter(r=>r.username.toLowerCase().includes(e)||r.email&&r.email.toLowerCase().includes(e))}return R.value&&(R.value==="active"?a=a.filter(e=>e.is_active):R.value==="inactive"&&(a=a.filter(e=>!e.is_active))),a}),ge={username:[{required:!0,message:"请输入用户名",trigger:"blur"},{min:3,max:50,message:"用户名长度在 3 到 50 个字符",trigger:"blur"}],password:[{required:!0,message:"请输入密码",trigger:"blur"},{min:8,message:"密码长度不能少于 8 个字符",trigger:"blur"}],confirmPassword:[{required:!0,message:"请确认密码",trigger:"blur"},{validator:(a,e,r)=>{e!==i.password?r(new Error("两次输入密码不一致")):r()},trigger:"blur"}],email:[{type:"email",message:"请输入正确的邮箱地址",trigger:"blur"}],role:[{required:!0,message:"请选择用户角色",trigger:"change"}]},_e={username:[{required:!0,message:"请输入用户名",trigger:"blur"},{min:3,max:50,message:"用户名长度在 3 到 50 个字符",trigger:"blur"}],email:[{type:"email",message:"请输入正确的邮箱地址",trigger:"blur"}],role:[{required:!0,message:"请选择用户角色",trigger:"change"}]},we={new_password:[{required:!0,message:"请输入新密码",trigger:"blur"},{min:8,message:"密码长度不能少于 8 个字符",trigger:"blur"}],confirmPassword:[{required:!0,message:"请确认密码",trigger:"blur"},{validator:(a,e,r)=>{e!==w.new_password?r(new Error("两次输入密码不一致")):r()},trigger:"blur"}]},b=async()=>{var a,e,r;try{X.value=!0;const n={skip:(A.value-1)*E.value,limit:E.value,active_only:!1};T.value&&(n.role_filter=T.value);const o=await Ye(n);if(!o){G.value=[],J.value=0;return}let v=[],h=0;o.users&&Array.isArray(o.users)?(v=o.users,h=o.total||0):(a=o.data)!=null&&a.users&&Array.isArray(o.data.users)?(v=o.data.users,h=o.data.total||0):Array.isArray(o)?(v=o,h=o.length):o.data&&Array.isArray(o.data)?(v=o.data,h=o.data.length):(v=[],h=0),G.value=v,J.value=h}catch(n){console.error("加载用户列表失败:",n),G.value=[],J.value=0,y.error("加载用户列表失败: "+(((r=(e=n.response)==null?void 0:e.data)==null?void 0:r.detail)||n.message))}finally{X.value=!1}},N=async()=>{var a;try{((a=me.value)==null?void 0:a.toLowerCase())==="admin"&&(S.value=await Ze())}catch(e){console.error("加载统计信息失败:",e)}},ye=async()=>{try{const a=await ra();Array.isArray(a)?x.value=a:a.roles&&Array.isArray(a.roles)?x.value=a.roles:a.data&&Array.isArray(a.data)?x.value=a.data:x.value=[]}catch(a){console.error("加载角色列表失败:",a),x.value=[]}},be=async()=>{try{const a=await oa();Array.isArray(a)?L.value=a:a.themes&&Array.isArray(a.themes)?L.value=a.themes:a.data&&Array.isArray(a.data)?L.value=a.data:L.value=[]}catch(a){console.error("加载主题列表失败:",a),L.value=[]}},Ve=()=>{A.value=1},he=()=>{B.value="",T.value="",R.value="",A.value=1,b()},Ue=({prop:a,order:e})=>{},Ce=a=>{E.value=a,A.value=1,b()},ke=a=>{A.value=a,b()},xe=a=>{te.value=a,d.username=a.username,d.email=a.email||"",d.role=a.role,d.theme=a.theme,d.is_active=a.is_active,M.value=!0},Ae=async()=>{var a,e;try{if(!await ae.value.validate())return;Y.value=!0,await ea({username:i.username,password:i.password,email:i.email||void 0,role:i.role}),y.success("用户创建成功"),D.value=!1,ce(),b(),N()}catch(r){console.error("创建用户失败:",r),y.error(((e=(a=r.response)==null?void 0:a.data)==null?void 0:e.detail)||"创建用户失败")}finally{Y.value=!1}},Pe=async()=>{var a,e;try{if(!await ie.value.validate())return;Z.value=!0,await aa(te.value.id,{username:d.username,email:d.email||void 0,role:d.role,theme:d.theme,is_active:d.is_active}),y.success("用户更新成功"),M.value=!1,b(),N()}catch(r){console.error("更新用户失败:",r),y.error(((e=(a=r.response)==null?void 0:a.data)==null?void 0:e.detail)||"更新用户失败")}finally{Z.value=!1}},Re=async()=>{var a,e;try{if(!await le.value.validate())return;ee.value=!0,await ta(te.value.id,{new_password:w.new_password}),y.success("密码重置成功"),q.value=!1,w.new_password="",w.confirmPassword=""}catch(r){console.error("重置密码失败:",r),y.error(((e=(a=r.response)==null?void 0:a.data)==null?void 0:e.detail)||"重置密码失败")}finally{ee.value=!1}},Fe=async a=>{var e,r;try{const n=a.is_active?"停用":"启用";await ve.confirm(`确定要${n}用户 "${a.username}" 吗？`,"确认操作",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}),await sa(a.id),y.success(`用户${n}成功`),b(),N()}catch(n){n!=="cancel"&&(console.error("切换用户状态失败:",n),y.error(((r=(e=n.response)==null?void 0:e.data)==null?void 0:r.detail)||"操作失败"))}},ze=async a=>{var e,r;try{await ve.confirm(`确定要删除用户 "${a.username}" 吗？此操作不可恢复！`,"确认删除",{confirmButtonText:"删除",cancelButtonText:"取消",type:"error"}),await la(a.id),y.success("用户删除成功"),b(),N()}catch(n){n!=="cancel"&&(console.error("删除用户失败:",n),y.error(((r=(e=n.response)==null?void 0:e.data)==null?void 0:r.detail)||"删除用户失败"))}},ce=()=>{var a;i.username="",i.password="",i.confirmPassword="",i.email="",i.role="user",(a=ae.value)==null||a.resetFields()},$e=a=>({admin:"danger",manager:"warning",user:"info",readonly:"success"})[a]||"info",Se=a=>({admin:"管理员",manager:"经理",user:"普通用户",readonly:"只读用户"})[a]||a,Le=a=>a?new Date(a).toLocaleString("zh-CN"):"-";return ue([T,R],()=>{A.value=1}),Ne(async()=>{await Promise.all([b(),N(),ye(),be()])}),ue(D,a=>{a||ce()}),ue(q,a=>{var e;a||(w.new_password="",w.confirmPassword="",(e=le.value)==null||e.resetFields())}),(a,e)=>{const r=c("el-button"),n=c("el-icon"),o=c("el-card"),v=c("el-col"),h=c("el-row"),U=c("el-input"),F=c("el-option"),I=c("el-select"),P=c("el-table-column"),se=c("el-tag"),Te=c("el-table"),De=c("el-pagination"),_=c("el-form-item"),re=c("el-form"),oe=c("el-dialog"),qe=c("el-switch"),Be=Ie("loading");return f(),V(Xe,null,{default:s(()=>[u("div",na,[u("div",ua,[e[26]||(e[26]=u("div",{class:"header-left"},[u("h1",null,"用户管理"),u("p",{class:"page-description"},"管理系统用户账号和权限")],-1)),u("div",ia,[O.value?(f(),V(r,{key:0,type:"primary",icon:z(Qe),onClick:e[0]||(e[0]=l=>D.value=!0)},{default:s(()=>[...e[25]||(e[25]=[p(" 新建用户 ",-1)])]),_:1},8,["icon"])):j("",!0)])]),S.value?(f(),Q("div",da,[t(h,{gutter:20},{default:s(()=>[t(v,{span:6},{default:s(()=>[t(o,{class:"stat-card"},{default:s(()=>[u("div",ma,[u("div",ca,C(S.value.total_users),1),e[27]||(e[27]=u("div",{class:"stat-label"},"总用户数",-1))]),t(n,{class:"stat-icon"},{default:s(()=>[t(z(Ge))]),_:1})]),_:1})]),_:1}),t(v,{span:6},{default:s(()=>[t(o,{class:"stat-card"},{default:s(()=>[u("div",pa,[u("div",va,C(S.value.active_users),1),e[28]||(e[28]=u("div",{class:"stat-label"},"活跃用户",-1))]),t(n,{class:"stat-icon active"},{default:s(()=>[t(z(Je))]),_:1})]),_:1})]),_:1}),t(v,{span:6},{default:s(()=>[t(o,{class:"stat-card"},{default:s(()=>{var l;return[u("div",fa,[u("div",ga,C(((l=S.value.role_distribution)==null?void 0:l.admin)||0),1),e[29]||(e[29]=u("div",{class:"stat-label"},"管理员",-1))]),t(n,{class:"stat-icon admin"},{default:s(()=>[t(z(Oe))]),_:1})]}),_:1})]),_:1}),t(v,{span:6},{default:s(()=>[t(o,{class:"stat-card"},{default:s(()=>[u("div",_a,[u("div",wa,C(S.value.inactive_users),1),e[30]||(e[30]=u("div",{class:"stat-label"},"停用用户",-1))]),t(n,{class:"stat-icon inactive"},{default:s(()=>[t(z(He))]),_:1})]),_:1})]),_:1})]),_:1})])):j("",!0),t(o,{class:"filter-card"},{default:s(()=>[t(h,{gutter:20},{default:s(()=>[t(v,{span:8},{default:s(()=>[t(U,{modelValue:B.value,"onUpdate:modelValue":e[1]||(e[1]=l=>B.value=l),placeholder:"搜索用户名或邮箱","prefix-icon":z(Ke),clearable:"",onInput:Ve},null,8,["modelValue","prefix-icon"])]),_:1}),t(v,{span:6},{default:s(()=>[t(I,{modelValue:T.value,"onUpdate:modelValue":e[2]||(e[2]=l=>T.value=l),placeholder:"选择角色",clearable:"",onChange:b},{default:s(()=>[(f(!0),Q(W,null,K(x.value,l=>(f(),V(F,{key:l.value,label:l.label,value:l.value},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),t(v,{span:6},{default:s(()=>[t(I,{modelValue:R.value,"onUpdate:modelValue":e[3]||(e[3]=l=>R.value=l),placeholder:"选择状态",clearable:"",onChange:b},{default:s(()=>[t(F,{label:"全部用户",value:""}),t(F,{label:"活跃用户",value:"active"}),t(F,{label:"停用用户",value:"inactive"})]),_:1},8,["modelValue"])]),_:1}),t(v,{span:4},{default:s(()=>[t(r,{onClick:he,icon:z(We)},{default:s(()=>[...e[31]||(e[31]=[p("重置",-1)])]),_:1},8,["icon"])]),_:1})]),_:1})]),_:1}),t(o,{class:"table-card"},{default:s(()=>[je((f(),V(Te,{data:fe.value,stripe:"",style:{width:"100%"},onSortChange:Ue},{default:s(()=>[t(P,{prop:"id",label:"ID",align:"center",width:"80",sortable:""}),t(P,{prop:"username",label:"用户名",align:"center","min-width":"120",sortable:""}),t(P,{prop:"email",label:"邮箱",align:"center","min-width":"180"}),t(P,{prop:"role",label:"角色",align:"center",width:"100"},{default:s(({row:l})=>[t(se,{type:$e(l.role),size:"small"},{default:s(()=>[p(C(Se(l.role)),1)]),_:2},1032,["type"])]),_:1}),t(P,{prop:"theme",label:"主题",align:"center",width:"100"},{default:s(({row:l})=>[t(se,{type:l.theme==="dark"?"info":"success",size:"small"},{default:s(()=>[p(C(l.theme==="dark"?"暗黑":"明亮"),1)]),_:2},1032,["type"])]),_:1}),t(P,{prop:"is_active",label:"状态",align:"center",width:"100"},{default:s(({row:l})=>[t(se,{type:l.is_active?"success":"danger",size:"small"},{default:s(()=>[p(C(l.is_active?"活跃":"停用"),1)]),_:2},1032,["type"])]),_:1}),t(P,{prop:"created_at",label:"创建时间",align:"center",width:"180",sortable:""},{default:s(({row:l})=>[p(C(Le(l.created_at)),1)]),_:1}),t(P,{label:"操作",width:"200",align:"center",fixed:"right"},{default:s(({row:l})=>[O.value?(f(),V(r,{key:0,size:"small",type:"primary",onClick:pe=>xe(l)},{default:s(()=>[...e[32]||(e[32]=[p(" 编辑 ",-1)])]),_:2},1032,["onClick"])):j("",!0),O.value&&l.id!==de.value?(f(),V(r,{key:1,size:"small",type:l.is_active?"warning":"primary",onClick:pe=>Fe(l)},{default:s(()=>[p(C(l.is_active?"停用":"启用"),1)]),_:2},1032,["type","onClick"])):j("",!0),O.value&&l.id!==de.value?(f(),V(r,{key:2,size:"small",type:"danger",plain:"",onClick:pe=>ze(l)},{default:s(()=>[...e[33]||(e[33]=[p(" 删除 ",-1)])]),_:2},1032,["onClick"])):j("",!0)]),_:1})]),_:1},8,["data"])),[[Be,X.value]]),u("div",ya,[t(De,{"current-page":A.value,"onUpdate:currentPage":e[4]||(e[4]=l=>A.value=l),"page-size":E.value,"onUpdate:pageSize":e[5]||(e[5]=l=>E.value=l),"page-sizes":[10,20,50,100],total:J.value,layout:"total, sizes, prev, pager, next, jumper",onSizeChange:Ce,onCurrentChange:ke},null,8,["current-page","page-size","total"])])]),_:1}),t(oe,{modelValue:D.value,"onUpdate:modelValue":e[12]||(e[12]=l=>D.value=l),title:"创建新用户",width:"500px","close-on-click-modal":!1},{footer:s(()=>[u("span",ba,[t(r,{onClick:e[11]||(e[11]=l=>D.value=!1)},{default:s(()=>[...e[34]||(e[34]=[p("取消",-1)])]),_:1}),t(r,{type:"primary",onClick:Ae,loading:Y.value},{default:s(()=>[...e[35]||(e[35]=[p(" 创建 ",-1)])]),_:1},8,["loading"])])]),default:s(()=>[t(re,{ref_key:"createFormRef",ref:ae,model:i,rules:ge,"label-width":"80px"},{default:s(()=>[t(_,{label:"用户名",prop:"username"},{default:s(()=>[t(U,{modelValue:i.username,"onUpdate:modelValue":e[6]||(e[6]=l=>i.username=l),placeholder:"请输入用户名",maxlength:"50","show-word-limit":""},null,8,["modelValue"])]),_:1}),t(_,{label:"密码",prop:"password"},{default:s(()=>[t(U,{modelValue:i.password,"onUpdate:modelValue":e[7]||(e[7]=l=>i.password=l),type:"password",placeholder:"请输入密码","show-password":"",maxlength:"128"},null,8,["modelValue"])]),_:1}),t(_,{label:"确认密码",prop:"confirmPassword"},{default:s(()=>[t(U,{modelValue:i.confirmPassword,"onUpdate:modelValue":e[8]||(e[8]=l=>i.confirmPassword=l),type:"password",placeholder:"请再次输入密码","show-password":"",maxlength:"128"},null,8,["modelValue"])]),_:1}),t(_,{label:"邮箱",prop:"email"},{default:s(()=>[t(U,{modelValue:i.email,"onUpdate:modelValue":e[9]||(e[9]=l=>i.email=l),placeholder:"请输入邮箱地址",maxlength:"100"},null,8,["modelValue"])]),_:1}),t(_,{label:"角色",prop:"role"},{default:s(()=>[t(I,{modelValue:i.role,"onUpdate:modelValue":e[10]||(e[10]=l=>i.role=l),placeholder:"请选择角色",style:{width:"100%"}},{default:s(()=>[(f(!0),Q(W,null,K(x.value,l=>(f(),V(F,{key:l.value,label:l.label,value:l.value},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"]),t(oe,{modelValue:M.value,"onUpdate:modelValue":e[20]||(e[20]=l=>M.value=l),title:"编辑用户",width:"500px","close-on-click-modal":!1},{footer:s(()=>[u("span",Va,[t(r,{onClick:e[18]||(e[18]=l=>M.value=!1)},{default:s(()=>[...e[36]||(e[36]=[p("取消",-1)])]),_:1}),t(r,{type:"warning",onClick:e[19]||(e[19]=l=>q.value=!0)},{default:s(()=>[...e[37]||(e[37]=[p(" 重置密码 ",-1)])]),_:1}),t(r,{type:"primary",onClick:Pe,loading:Z.value},{default:s(()=>[...e[38]||(e[38]=[p(" 更新 ",-1)])]),_:1},8,["loading"])])]),default:s(()=>[t(re,{ref_key:"editFormRef",ref:ie,model:d,rules:_e,"label-width":"80px"},{default:s(()=>[t(_,{label:"用户名",prop:"username"},{default:s(()=>[t(U,{modelValue:d.username,"onUpdate:modelValue":e[13]||(e[13]=l=>d.username=l),placeholder:"请输入用户名",maxlength:"50","show-word-limit":""},null,8,["modelValue"])]),_:1}),t(_,{label:"邮箱",prop:"email"},{default:s(()=>[t(U,{modelValue:d.email,"onUpdate:modelValue":e[14]||(e[14]=l=>d.email=l),placeholder:"请输入邮箱地址",maxlength:"100"},null,8,["modelValue"])]),_:1}),t(_,{label:"角色",prop:"role"},{default:s(()=>[t(I,{modelValue:d.role,"onUpdate:modelValue":e[15]||(e[15]=l=>d.role=l),placeholder:"请选择角色",style:{width:"100%"}},{default:s(()=>[(f(!0),Q(W,null,K(x.value,l=>(f(),V(F,{key:l.value,label:l.label,value:l.value},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),t(_,{label:"主题",prop:"theme"},{default:s(()=>[t(I,{modelValue:d.theme,"onUpdate:modelValue":e[16]||(e[16]=l=>d.theme=l),placeholder:"请选择主题",style:{width:"100%"}},{default:s(()=>[(f(!0),Q(W,null,K(L.value,l=>(f(),V(F,{key:l.value,label:l.label,value:l.value},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),t(_,{label:"状态",prop:"is_active"},{default:s(()=>[t(qe,{modelValue:d.is_active,"onUpdate:modelValue":e[17]||(e[17]=l=>d.is_active=l),"active-text":"启用","inactive-text":"停用"},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"]),t(oe,{modelValue:q.value,"onUpdate:modelValue":e[24]||(e[24]=l=>q.value=l),title:"重置密码",width:"400px","close-on-click-modal":!1},{footer:s(()=>[u("span",ha,[t(r,{onClick:e[23]||(e[23]=l=>q.value=!1)},{default:s(()=>[...e[39]||(e[39]=[p("取消",-1)])]),_:1}),t(r,{type:"primary",onClick:Re,loading:ee.value},{default:s(()=>[...e[40]||(e[40]=[p(" 重置 ",-1)])]),_:1},8,["loading"])])]),default:s(()=>[t(re,{ref_key:"resetPasswordFormRef",ref:le,model:w,rules:we,"label-width":"80px"},{default:s(()=>[t(_,{label:"新密码",prop:"new_password"},{default:s(()=>[t(U,{modelValue:w.new_password,"onUpdate:modelValue":e[21]||(e[21]=l=>w.new_password=l),type:"password",placeholder:"请输入新密码","show-password":"",maxlength:"128"},null,8,["modelValue"])]),_:1}),t(_,{label:"确认密码",prop:"confirmPassword"},{default:s(()=>[t(U,{modelValue:w.confirmPassword,"onUpdate:modelValue":e[22]||(e[22]=l=>w.confirmPassword=l),type:"password",placeholder:"请再次输入新密码","show-password":"",maxlength:"128"},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"])])]),_:1})}}},xa=Ee(Ua,[["__scopeId","data-v-e195843d"]]);export{xa as default};
